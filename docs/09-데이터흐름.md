# 9. ë°ì´í„° íë¦„ (Data Flow)

## ëª©ì°¨
1. [ê°œìš”](#ê°œìš”)
2. [User Request â†’ Response ì „ì²´ íë¦„](#user-request--response-ì „ì²´-íë¦„)
3. [NavigateTo ìƒì„¸ íë¦„](#navigateto-ìƒì„¸-íë¦„)
4. [ShadowDOM ì—…ë°ì´íŠ¸ íƒ€ì´ë°](#shadowdom-ì—…ë°ì´íŠ¸-íƒ€ì´ë°)
5. [LLM Mode ì„ íƒ ë° ì‚¬ìš©](#llm-mode-ì„ íƒ-ë°-ì‚¬ìš©)
6. [Storage ì˜ì†í™” íë¦„](#storage-ì˜ì†í™”-íë¦„)
7. [Tool ì‹¤í–‰ íë¦„](#tool-ì‹¤í–‰-íë¦„)
8. [Message íë¦„](#message-íë¦„)

---

## ê°œìš”

GAIëŠ” **Agentic Loop**ë¥¼ ì¤‘ì‹¬ìœ¼ë¡œ ë°ì´í„°ê°€ ìˆœí™˜í•˜ë©°, LLMì´ ë„êµ¬ë¥¼ ë°˜ë³µì ìœ¼ë¡œ í˜¸ì¶œí•˜ì—¬ ì‘ì—…ì„ ì™„ë£Œí•©ë‹ˆë‹¤.

**í•µì‹¬ ë°ì´í„° íë¦„**:
1. **User Request â†’ Agent â†’ LLM â†’ Tool â†’ LLM â†’ Response**
2. **NavigationBrain â†’ VLM â†’ Action â†’ Verification â†’ Storage**
3. **ShadowDOM â†’ OCR + VLM â†’ StateHash â†’ Node**
4. **Config â†’ LLMManager â†’ Provider â†’ API â†’ Response**

**ë°ì´í„° ì €ì¥ì†Œ**:
- **In-Memory**: Message History, NavigationGraph, ShadowDOM
- **Persistent**: JSON Storage (data/brain/navigation.json)
- **Temporary**: Screenshot buffers, OCR results

---

## User Request â†’ Response ì „ì²´ íë¦„

### ì „ì²´ ë‹¤ì´ì–´ê·¸ë¨

```
User Input (CLI)
    â†“
index.ts main()
    â†“
Agent.processRequest(input)
    â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚      Agentic Loop (ìµœëŒ€ 10íšŒ)        â”‚
â”‚                                     â”‚
â”‚  1. LLMManager.send(tools)          â”‚
â”‚       â†“                             â”‚
â”‚  2. AnthropicLLM.send(messages)     â”‚
â”‚       â†“                             â”‚
â”‚  3. Anthropic API                   â”‚
â”‚       â†“                             â”‚
â”‚  4. LLM Response                    â”‚
â”‚      - content: "..."               â”‚
â”‚      - toolCalls: [...]             â”‚
â”‚       â†“                             â”‚
â”‚  5. Tool Calls ìˆëŠ”ê°€?               â”‚
â”‚      â”œâ”€ ì—†ìŒ â†’ ì¢…ë£Œ (finished=true) â”‚
â”‚      â””â”€ ìˆìŒ â†“                      â”‚
â”‚                                     â”‚
â”‚  6. ToolRegistry.execute(toolCall)  â”‚
â”‚       â†“                             â”‚
â”‚  7. Tool.execute(input)             â”‚
â”‚       â†“                             â”‚
â”‚  8. ToolResult                      â”‚
â”‚      - success: true/false          â”‚
â”‚      - data: "..." / error: "..."   â”‚
â”‚       â†“                             â”‚
â”‚  9. LLMManager.addToolResult()      â”‚
â”‚       â†“                             â”‚
â”‚  10. Loop ë°˜ë³µ (1ë²ˆìœ¼ë¡œ)             â”‚
â”‚                                     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
    â†“
AgentResponse
  - message: "ìµœì¢… ì‘ë‹µ"
  - finished: true/false
    â†“
Console Output
```

### ë‹¨ê³„ë³„ ìƒì„¸

#### 1. User Input (CLI)

```typescript
// index.ts
const userInput = process.argv.slice(2).join(' ');
// ì˜ˆ: "Navigate to Chrome"
```

**ë°ì´í„°**:
- íƒ€ì…: `string`
- ì˜ˆì‹œ: `"Navigate to Chrome"`

#### 2. Agent.processRequest(input)

```typescript
async processRequest(input: string): Promise<AgentResponse> {
  // ì‚¬ìš©ì ë©”ì‹œì§€ë¥¼ íˆìŠ¤í† ë¦¬ì— ì¶”ê°€
  this.llmManager.addUserMessage(input);

  let iterations = 0;
  while (iterations < this.maxIterations) {
    // Agentic loop...
  }
}
```

**ì´ˆê¸° íˆìŠ¤í† ë¦¬**:
```typescript
[
  {
    role: 'user',
    content: 'Navigate to Chrome'
  }
]
```

#### 3. LLMManager.send(tools)

```typescript
const tools = this.toolRegistry.getDefinitions();
const response = await this.llmManager.send(tools);
```

**tools (ToolDefinition[])**:
```typescript
[
  {
    name: 'launch_app',
    description: 'Launch an application via Spotlight...',
    input_schema: { type: 'object', properties: {...} }
  },
  {
    name: 'navigate_to',
    description: 'Navigate to a specific screen or state...',
    input_schema: {...}
  },
  // ... ì´ 12ê°œ ë„êµ¬
]
```

#### 4. AnthropicLLM.send(messages)

```typescript
const response = await this.client.messages.create({
  model: this.config.model,
  max_tokens: this.config.maxTokens,
  messages: this.history,
  tools: tools, // Tool definitions
});
```

**API Request**:
```json
{
  "model": "claude-sonnet-4-5-20250929",
  "max_tokens": 8096,
  "messages": [
    {
      "role": "user",
      "content": "Navigate to Chrome"
    }
  ],
  "tools": [...]
}
```

#### 5. LLM Response

```typescript
{
  content: [
    {
      type: 'text',
      text: "I'll help you navigate to Chrome by launching it via Spotlight."
    },
    {
      type: 'tool_use',
      id: 'toolu_01A',
      name: 'launch_app',
      input: { appName: 'Google Chrome' }
    }
  ],
  stop_reason: 'tool_use'
}
```

**ë³€í™˜ í›„ (ìš°ë¦¬ í¬ë§·)**:
```typescript
{
  content: "I'll help you navigate to Chrome by launching it via Spotlight.",
  toolCalls: [
    {
      id: 'toolu_01A',
      name: 'launch_app',
      input: { appName: 'Google Chrome' }
    }
  ],
  stopReason: 'tool_use'
}
```

#### 6. ToolRegistry.execute(toolCall)

```typescript
const tool = this.tools.get('launch_app'); // LaunchAppTool
const result = await tool.execute({ appName: 'Google Chrome' });
```

#### 7. Tool.execute(input)

```typescript
// LaunchAppTool.execute()
async execute(input: ToolInput): Promise<ToolResult> {
  // 1. Spotlight ì—´ê¸°
  await KeyboardController.pressKey("space", ["command"]);
  await delay(300);

  // 2. ì•± ì´ë¦„ íƒ€ì´í•‘
  KeyboardController.typeText("Google Chrome", 50);
  await delay(500);

  // 3. Enter
  KeyboardController.pressEnter();
  await delay(2000);

  return {
    success: true,
    data: JSON.stringify({
      appName: 'Google Chrome',
      method: 'spotlight',
      message: 'Successfully launched Google Chrome via Spotlight'
    })
  };
}
```

#### 8. ToolResult

```typescript
{
  success: true,
  data: '{"appName":"Google Chrome","method":"spotlight","message":"Successfully launched..."}'
}
```

#### 9. LLMManager.addToolResult()

```typescript
this.llmManager.addToolResult('toolu_01A', result.data);
```

**íˆìŠ¤í† ë¦¬ ì—…ë°ì´íŠ¸**:
```typescript
[
  { role: 'user', content: 'Navigate to Chrome' },
  { role: 'assistant', content: [...], tool_calls: [...] },
  { role: 'tool', tool_call_id: 'toolu_01A', content: '{"appName":...}' }
]
```

#### 10. Loop ë°˜ë³µ

ë‹¤ì‹œ LLM í˜¸ì¶œ:
```typescript
const response = await this.llmManager.send(tools);
```

**LLM Response (2ì°¨)**:
```typescript
{
  content: "I've successfully launched Google Chrome using Spotlight.",
  toolCalls: null, // Tool call ì—†ìŒ â†’ ì¢…ë£Œ
  stopReason: 'end_turn'
}
```

#### 11. AgentResponse

```typescript
{
  message: "I've successfully launched Google Chrome using Spotlight.",
  finished: true
}
```

#### 12. Console Output

```typescript
console.log('âœ¨ Final Response:\n');
console.log(response.message);
console.log('\nâœ… Task completed!');
```

---

## NavigateTo ìƒì„¸ íë¦„

### ì „ì²´ ë‹¤ì´ì–´ê·¸ë¨

```
User: "Navigate to Settings"
    â†“
NavigateToTool.execute({target: "Settings"})
    â†“
NavigationBrain.navigateTo("Settings")
    â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  1. identifyCurrentNode()                           â”‚
â”‚      â†“                                              â”‚
â”‚     captureScreenBuffer() â†’ PNG Buffer              â”‚
â”‚      â†“                                              â”‚
â”‚     OCR.analyze() â†’ OCRAnalysis                     â”‚
â”‚      â†“                                              â”‚
â”‚     VLMAnalyzer.extractProgramName() â†’ "Finder"     â”‚
â”‚     VLMAnalyzer.identifyUIElements() â†’ UIElement[]  â”‚
â”‚      â†“                                              â”‚
â”‚     StateHasher.hashElements() â†’ stateHash          â”‚
â”‚      â†“                                              â”‚
â”‚     NodeId = {programName: "Finder", stateHash}     â”‚
â”‚      â†“                                              â”‚
â”‚     updateShadowDOM(nodeId)                         â”‚
â”‚                                                     â”‚
â”‚  2. getPathsFrom(fromNodeId)                        â”‚
â”‚      â†“                                              â”‚
â”‚     ê¸°ì¡´ ê²½ë¡œ ê²€ìƒ‰ (JSON Storage)                    â”‚
â”‚      â†“                                              â”‚
â”‚     ê²½ë¡œ ìˆìŒ? â†’ executePath() (Step 4)             â”‚
â”‚     ê²½ë¡œ ì—†ìŒ? â†’ learnPath() (Step 3)               â”‚
â”‚                                                     â”‚
â”‚  3. learnPath(targetDescription)                    â”‚
â”‚      â†“                                              â”‚
â”‚     captureScreenBuffer() + OCR                     â”‚
â”‚      â†“                                              â”‚
â”‚     VLMAnalyzer.learnNavigationPath()               â”‚
â”‚       - LLMì—ê²Œ í˜„ì¬ í™”ë©´ + ëª©í‘œ ì „ë‹¬                â”‚
â”‚       - LLMì´ Action[] ìƒì„±                         â”‚
â”‚      â†“                                              â”‚
â”‚     Path = {id, fromNodeId, toNodeId, actions, ...} â”‚
â”‚      â†“                                              â”‚
â”‚     storage.addPath(path)                           â”‚
â”‚                                                     â”‚
â”‚  4. executePath(path)                               â”‚
â”‚      â†“                                              â”‚
â”‚     for each action in path.actions:                â”‚
â”‚       â”œâ”€ executeAction(action)                      â”‚
â”‚       â”‚    â”œâ”€ ClickAction â†’ MouseController.clickAt â”‚
â”‚       â”‚    â”œâ”€ TypeAction â†’ KeyboardController.type â”‚
â”‚       â”‚    â”œâ”€ HotkeyAction â†’ KeyboardController.keyâ”‚
â”‚       â”‚    â”œâ”€ WaitAction â†’ delay()                 â”‚
â”‚       â”‚    â””â”€ ScrollAction â†’ MouseController.scrollâ”‚
â”‚       â”‚                                             â”‚
â”‚       â”œâ”€ delay(500) - UI ì•ˆì •í™”                     â”‚
â”‚       â”‚                                             â”‚
â”‚       â”œâ”€ updateShadowDOM()                          â”‚
â”‚       â”‚                                             â”‚
â”‚       â””â”€ verifyActionResult()                       â”‚
â”‚            â†“                                        â”‚
â”‚           OCR + VLMìœ¼ë¡œ ê¸°ëŒ€ ìš”ì†Œ í™•ì¸               â”‚
â”‚                                                     â”‚
â”‚  5. identifyCurrentNode() - ë„ì°© í™•ì¸                â”‚
â”‚      â†“                                              â”‚
â”‚     ëª©í‘œ NodeIdì™€ ì¼ì¹˜? â†’ ì„±ê³µ                       â”‚
â”‚                                                     â”‚
â”‚  6. storage.updatePath() - ì„±ê³µë¥  ì—…ë°ì´íŠ¸           â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
    â†“
Return: success (true/false)
```

### ë°ì´í„° íë¦„ ìƒì„¸

#### 1. identifyCurrentNode() ë°ì´í„°

**ì…ë ¥**: ì—†ìŒ (í˜„ì¬ í™”ë©´ ìº¡ì²˜)

**ì¤‘ê°„ ë°ì´í„°**:
```typescript
// Screenshot
const screenshotBuffer: Buffer = PNG ì´ë¯¸ì§€

// OCR Result
const ocrAnalysis: OCRAnalysis = {
  fullText: "Finder Desktop Documents Downloads...",
  elements: [
    { text: "Finder", confidence: 0.98, bbox: {x: 10, y: 10, width: 80, height: 30} },
    { text: "Desktop", confidence: 0.95, bbox: {...} },
    // ...
  ]
}

// VLM Analysis
const programName: string = "Finder"
const uiElements: UIElement[] = [
  {
    type: 'button',
    text: 'Desktop',
    description: 'Folder in sidebar',
    bbox: {x: 10, y: 50, width: 100, height: 30},
    confidence: 0.9
  },
  // ...
]

// State Hash
const stateHash: string = "a3b2c1d4e5f6..." // SHA-256

// NodeId
const nodeId: NodeId = {
  programName: "Finder",
  stateHash: "a3b2c1d4e5f6..."
}
```

**ì¶œë ¥**: `NodeId`

#### 2. learnPath() ë°ì´í„°

**ì…ë ¥**:
```typescript
targetDescription: "Settings"
```

**ì¤‘ê°„ ë°ì´í„°**:
```typescript
// VLM Prompt
const prompt = `
You are navigating from the current screen to: Settings

Current screen analysis:
- Program: Finder
- UI Elements: [
    {type: 'button', text: 'Desktop', ...},
    {type: 'menu', text: 'File', ...},
    ...
  ]
- OCR Text: "Finder Desktop Documents..."

Please provide a list of actions to navigate to the target.
`

// VLM Response
const actions: Action[] = [
  {
    type: 'hotkey',
    modifiers: ['command'],
    key: 'space',
    description: 'Open Spotlight'
  },
  {
    type: 'type',
    text: 'System Preferences',
    pressEnter: true,
    description: 'Search for System Preferences'
  },
  {
    type: 'wait',
    duration: 2000,
    description: 'Wait for app to launch'
  }
]
```

**ì¶œë ¥**:
```typescript
const path: Path = {
  id: 'path-uuid',
  fromNodeId: {programName: "Finder", stateHash: "..."},
  toNodeId: {programName: "System Preferences", stateHash: null}, // ì•„ì§ ë¯¸í™•ì •
  actions: actions,
  validation: {
    expectedElements: ["General", "Desktop & Screen Saver"],
    expectedText: ["System Preferences"],
    timeout: 5000
  },
  metadata: {
    learnedBy: 'vlm',
    successRate: 1.0,
    usageCount: 0,
    lastUsed: new Date(),
    averageDuration: null
  }
}
```

#### 3. executePath() ë°ì´í„°

**ì…ë ¥**: `Path` ê°ì²´

**ê° ì•¡ì…˜ ì‹¤í–‰ ë°ì´í„°**:
```typescript
// Action 1: Hotkey
{
  type: 'hotkey',
  modifiers: ['command'],
  key: 'space'
}
â†’ KeyboardController.pressKey('space', ['command'])
â†’ Spotlight ì—´ë¦¼

// Delay
â†’ delay(500)

// ShadowDOM Update
â†’ updateShadowDOM()
  â”œâ”€ captureScreenBuffer() â†’ Buffer
  â”œâ”€ OCR â†’ OCRAnalysis
  â”œâ”€ VLM â†’ UIElement[]
  â””â”€ ShadowDOM = {
      nodeId: {programName: "Spotlight", stateHash: "..."},
      screenshot: Buffer,
      uiElements: [...],
      ocrResult: {...},
      instanceHash: "..."
    }

// Verification
â†’ verifyActionResult(path, 0)
  â”œâ”€ OCR + VLM ê²€ì¦
  â”œâ”€ ê¸°ëŒ€ ìš”ì†Œ ìˆëŠ”ê°€?
  â””â”€ PathVerification = {
      actionIndex: 0,
      success: true,
      verifiedAt: new Date(),
      actualElements: [...],
      ocrConfidence: 0.95,
      vlmConfidence: 0.9
    }

// Action 2: Type
{
  type: 'type',
  text: 'System Preferences',
  pressEnter: true
}
â†’ KeyboardController.typeText('System Preferences')
â†’ KeyboardController.pressEnter()

// ... (ë°˜ë³µ)
```

**ì¶œë ¥**:
```typescript
const success: boolean = true
const verificationHistory: PathVerification[] = [...]
```

---

## ShadowDOM ì—…ë°ì´íŠ¸ íƒ€ì´ë°

### ì—…ë°ì´íŠ¸ ë°œìƒ ì‹œì 

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  ShadowDOM Update Triggers           â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  1. identifyCurrentNode()            â”‚
â”‚     â†’ í˜„ì¬ í™”ë©´ ì‹ë³„ ì‹œ               â”‚
â”‚                                      â”‚
â”‚  2. executePath()                    â”‚
â”‚     â†’ ê° ì•¡ì…˜ ì‹¤í–‰ í›„                â”‚
â”‚     â†’ for each action:               â”‚
â”‚         - executeAction()            â”‚
â”‚         - delay(500)                 â”‚
â”‚         - updateShadowDOM() â† HERE  â”‚
â”‚         - verifyActionResult()       â”‚
â”‚                                      â”‚
â”‚  3. navigateTo()                     â”‚
â”‚     â†’ ë„¤ë¹„ê²Œì´ì…˜ ì™„ë£Œ í›„              â”‚
â”‚                                      â”‚
â”‚  4. Manual Trigger                   â”‚
â”‚     â†’ NavigationBrain API ì§ì ‘ í˜¸ì¶œ  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### updateShadowDOM() íë¦„

```typescript
private async updateShadowDOM(nodeId: NodeId): Promise<void> {
  // 1. í™”ë©´ ìº¡ì²˜
  const screenshot = this.captureScreenBuffer();

  // 2. OCR ë¶„ì„
  let ocrResult: OCRAnalysis | undefined;
  if (OCRFactory.isSupported()) {
    const ocrProvider = OCRFactory.create();
    if (ocrProvider) {
      ocrResult = await ocrProvider.analyzeBuffer(screenshot);
    }
  }

  // 3. VLM ë¶„ì„
  const uiElements = await this.vlmAnalyzer.identifyUIElements(
    screenshot,
    ocrResult
  );

  // 4. Instance Hash ìƒì„±
  const instanceHash = StateHasher.hashElements(uiElements);

  // 5. ShadowDOM ìƒì„±
  this.shadowDOM = {
    nodeId,
    capturedAt: new Date(),
    screenshot,
    uiElements,
    ocrResult,
    vlmDescription: undefined,
    instanceHash,
  };
}
```

### ShadowDOM ë°ì´í„° êµ¬ì¡°

```typescript
{
  nodeId: {
    programName: "Finder",
    stateHash: "a3b2c1d4e5f6..."
  },
  capturedAt: new Date("2026-02-15T10:30:00Z"),
  screenshot: Buffer, // PNG ì´ë¯¸ì§€ (ìˆ˜ MB)
  uiElements: [
    {
      type: 'button',
      text: 'Desktop',
      description: 'Folder in sidebar',
      bbox: {x: 10, y: 50, width: 100, height: 30},
      confidence: 0.9
    },
    {
      type: 'menu',
      text: 'File',
      description: 'Menu bar item',
      bbox: {x: 100, y: 0, width: 50, height: 25},
      confidence: 0.95
    },
    // ... ì´ 20-50ê°œ ìš”ì†Œ
  ],
  ocrResult: {
    fullText: "Finder Desktop Documents Downloads...",
    elements: [...]
  },
  instanceHash: "b4c3d2e1f0..." // UIElementsì˜ hash
}
```

**ë©”ëª¨ë¦¬ ì‚¬ìš©ëŸ‰**:
- Screenshot: 2-5 MB (PNG)
- UIElements: ~50 KB
- OCRResult: ~10 KB
- **ì´**: ì•½ 2-5 MB per ShadowDOM

**ì €ì¥ ì—¬ë¶€**: ShadowDOMì€ **ë©”ëª¨ë¦¬ì—ë§Œ** ì¡´ì¬, JSON ì €ì¥ ì•ˆ ë¨

---

## LLM Mode ì„ íƒ ë° ì‚¬ìš©

### Mode êµ¬ë¶„

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  LLM Modes                                  â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  1. Default Mode (Stateful)                 â”‚
â”‚     - ì‚¬ìš©ì²˜: Agent.processRequest()         â”‚
â”‚     - LLM: claude-sonnet-4-5                â”‚
â”‚     - íˆìŠ¤í† ë¦¬: âœ… ìœ ì§€                       â”‚
â”‚     - Tool Calling: âœ… ì§€ì›                  â”‚
â”‚     - ë¹„ìš©: ì¤‘ê°„                            â”‚
â”‚                                             â”‚
â”‚  2. Fast Mode (Stateless)                   â”‚
â”‚     - ì‚¬ìš©ì²˜: SmartScreenReader (quick)     â”‚
â”‚     - LLM: claude-haiku-4-5                 â”‚
â”‚     - íˆìŠ¤í† ë¦¬: âŒ ì—†ìŒ                       â”‚
â”‚     - Tool Calling: âŒ ì—†ìŒ                  â”‚
â”‚     - ë¹„ìš©: ì €ë ´                            â”‚
â”‚                                             â”‚
â”‚  3. Vision Mode (Stateless)                 â”‚
â”‚     - ì‚¬ìš©ì²˜: VLMAnalyzer, SmartScreenReaderâ”‚
â”‚     - LLM: claude-opus-4-6                  â”‚
â”‚     - íˆìŠ¤í† ë¦¬: âŒ ì—†ìŒ                       â”‚
â”‚     - Tool Calling: âŒ ì—†ìŒ                  â”‚
â”‚     - Image: âœ… ì§€ì›                         â”‚
â”‚     - ë¹„ìš©: ë¹„ìŒˆ                            â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### Mode ì‚¬ìš© íë¦„

#### 1. Default Mode (Stateful)

```typescript
// Agent.processRequest()
const response = await this.llmManager.send(tools);
```

**ë‚´ë¶€**:
```typescript
// LLMManager.send()
async send(tools?: ToolDefinition[]): Promise<LLMResponse> {
  // Default LLM ì‚¬ìš© (Stateful)
  return await this.defaultLLM.send(this.defaultLLM.history, tools);
}
```

**íˆìŠ¤í† ë¦¬ ëˆ„ì **:
```typescript
// 1ì°¨ í˜¸ì¶œ
history = [
  { role: 'user', content: 'Navigate to Chrome' }
]

// 2ì°¨ í˜¸ì¶œ
history = [
  { role: 'user', content: 'Navigate to Chrome' },
  { role: 'assistant', content: [...], tool_calls: [...] },
  { role: 'tool', tool_call_id: '...', content: '...' }
]

// 3ì°¨ í˜¸ì¶œ
history = [
  ...,
  { role: 'assistant', content: '...' }
]
```

#### 2. Fast Mode (Stateless)

```typescript
// SmartScreenReaderTool (quick mode)
const response = await this.llmManager.sendWithMode('fast', [
  {
    role: 'user',
    content: 'Quickly summarize the current screen state.'
  }
]);
```

**ë‚´ë¶€**:
```typescript
// LLMManager.sendWithMode()
async sendWithMode(
  mode: 'default' | 'fast' | 'vision',
  messages: Message[],
  tools?: ToolDefinition[]
): Promise<LLMResponse> {
  const llm = mode === 'fast' ? this.fastLLM : this.visionLLM;
  // Stateless: ì „ë‹¬ëœ messagesë§Œ ì‚¬ìš©, íˆìŠ¤í† ë¦¬ ì—†ìŒ
  return await llm.sendOnce(messages, tools);
}
```

**íˆìŠ¤í† ë¦¬**: ì—†ìŒ (1íšŒì„± í˜¸ì¶œ)

#### 3. Vision Mode (Stateless)

```typescript
// VLMAnalyzer.identifyUIElements()
const response = await this.llmManager.sendWithMode('vision', [
  {
    role: 'user',
    content: [
      {
        type: 'text',
        text: 'Identify all UI elements in this screen.'
      },
      {
        type: 'image',
        source: {
          type: 'base64',
          data: base64Image,
          media_type: 'image/png'
        }
      }
    ]
  }
]);
```

**MultiModal Content**:
```typescript
content: [
  { type: 'text', text: '...' },
  { type: 'image', source: { type: 'base64', data: '...', media_type: 'image/png' } }
]
```

**íˆìŠ¤í† ë¦¬**: ì—†ìŒ (1íšŒì„± í˜¸ì¶œ)

### Mode ì„ íƒ ê¸°ì¤€

| ì‚¬ìš© ì‚¬ë¡€ | Mode | ì´ìœ  |
|----------|------|------|
| Agent loop | default | íˆìŠ¤í† ë¦¬ í•„ìš”, Tool calling |
| ë¹ ë¥¸ í™”ë©´ ìš”ì•½ | fast | ì €ë ´, íˆìŠ¤í† ë¦¬ ë¶ˆí•„ìš” |
| í™”ë©´ ë¶„ì„ (OCR í¬í•¨) | vision | ì´ë¯¸ì§€ ë¶„ì„ í•„ìš” |
| ë„¤ë¹„ê²Œì´ì…˜ ê²½ë¡œ í•™ìŠµ | vision | ì´ë¯¸ì§€ ê¸°ë°˜ Action ìƒì„± |
| UI ìš”ì†Œ ì‹ë³„ | vision | ì´ë¯¸ì§€ ë¶„ì„ í•„ìš” |

---

## Storage ì˜ì†í™” íë¦„

### NavigationGraph ì €ì¥/ë¡œë“œ

```
In-Memory (NavigationGraph)
    â†“
Serialize (Maps â†’ Arrays, Dates â†’ ISO strings)
    â†“
JSON String
    â†“
Write to File (data/brain/navigation.json)
    â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  JSON File Structure                â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  {                                  â”‚
â”‚    nodes: [                         â”‚
â”‚      {                              â”‚
â”‚        id: {programName, stateHash},â”‚
â”‚        metadata: {...},             â”‚
â”‚        childrenIds: [...]           â”‚
â”‚      },                             â”‚
â”‚      ...                            â”‚
â”‚    ],                               â”‚
â”‚    paths: [                         â”‚
â”‚      {                              â”‚
â”‚        id, fromNodeId, toNodeId,    â”‚
â”‚        actions, validation,         â”‚
â”‚        verificationHistory,         â”‚
â”‚        metadata                     â”‚
â”‚      },                             â”‚
â”‚      ...                            â”‚
â”‚    ]                                â”‚
â”‚  }                                  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
    â†“
Read from File
    â†“
JSON.parse()
    â†“
Deserialize (Arrays â†’ Maps, strings â†’ Dates)
    â†“
In-Memory (NavigationGraph)
```

### Serialization íë¦„

```typescript
// JSONStorage.save()
async save(graph: NavigationGraph): Promise<boolean> {
  // 1. Serialize
  const serializable: SerializableNavigationGraph = {
    nodes: Array.from(graph.nodes.entries()).map(([key, node]) => ({
      key,
      id: node.id,
      metadata: {
        ...node.metadata,
        createdAt: node.metadata.createdAt.toISOString(),
        lastVisitedAt: node.metadata.lastVisitedAt.toISOString(),
      },
      childrenIds: node.childrenIds,
    })),
    paths: Array.from(graph.paths.values()).map((path) => ({
      ...path,
      metadata: {
        ...path.metadata,
        lastUsed: path.metadata.lastUsed.toISOString(),
      },
      verificationHistory: path.verificationHistory?.map((v) => ({
        ...v,
        verifiedAt: v.verifiedAt.toISOString(),
      })),
    })),
  };

  // 2. JSON.stringify
  const json = JSON.stringify(serializable, null, 2);

  // 3. Write to file
  await fs.promises.writeFile(this.filePath, json, 'utf-8');

  return true;
}
```

### Deserialization íë¦„

```typescript
// JSONStorage.load()
async load(): Promise<NavigationGraph | null> {
  // 1. Read from file
  const content = await fs.promises.readFile(this.filePath, 'utf-8');

  // 2. JSON.parse
  const serializable: SerializableNavigationGraph = JSON.parse(content);

  // 3. Deserialize
  const graph: NavigationGraph = {
    nodes: new Map(
      serializable.nodes.map((n) => [
        n.key,
        {
          id: n.id,
          metadata: {
            ...n.metadata,
            createdAt: new Date(n.metadata.createdAt),
            lastVisitedAt: new Date(n.metadata.lastVisitedAt),
          },
          childrenIds: n.childrenIds,
        },
      ])
    ),
    paths: new Map(
      serializable.paths.map((p) => [
        p.id,
        {
          ...p,
          metadata: {
            ...p.metadata,
            lastUsed: new Date(p.metadata.lastUsed),
          },
          verificationHistory: p.verificationHistory?.map((v) => ({
            ...v,
            verifiedAt: new Date(v.verifiedAt),
          })),
        },
      ])
    ),
  };

  return graph;
}
```

### ì €ì¥ íƒ€ì´ë°

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Storage Save Triggers               â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  1. brain.addNode()                  â”‚
â”‚     â†’ ìƒˆ ë…¸ë“œ ì¶”ê°€ ì‹œ                 â”‚
â”‚     â†’ storage.save(graph)            â”‚
â”‚                                      â”‚
â”‚  2. brain.learnPath()                â”‚
â”‚     â†’ ìƒˆ ê²½ë¡œ í•™ìŠµ ì‹œ                 â”‚
â”‚     â†’ storage.addPath(path)          â”‚
â”‚     â†’ storage.save(graph)            â”‚
â”‚                                      â”‚
â”‚  3. brain.executePath()              â”‚
â”‚     â†’ ê²½ë¡œ ì‹¤í–‰ í›„ ì„±ê³µë¥  ì—…ë°ì´íŠ¸     â”‚
â”‚     â†’ storage.updatePath(path)       â”‚
â”‚     â†’ storage.save(graph)            â”‚
â”‚                                      â”‚
â”‚  4. Manual Trigger                   â”‚
â”‚     â†’ brain.saveGraph()              â”‚
â”‚     â†’ storage.save(graph)            â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## Tool ì‹¤í–‰ íë¦„

### Tool Call ë°ì´í„° íë¦„

```
LLM Response
  â†“
{
  type: 'tool_use',
  id: 'toolu_01A',
  name: 'click',
  input: { text: 'Login' }
}
  â†“
ToolCall (ìš°ë¦¬ í¬ë§·)
{
  id: 'toolu_01A',
  name: 'click',
  input: { text: 'Login' }
}
  â†“
ToolRegistry.execute(toolCall)
  â†“
ClickTool.execute({ text: 'Login' })
  â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  ClickTool ë‚´ë¶€ ë¡œì§             â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  1. validateInput(input)        â”‚
â”‚     â†’ text í•„ë“œ í™•ì¸             â”‚
â”‚                                 â”‚
â”‚  2. OCRFactory.create()         â”‚
â”‚     â†’ MacOCRProvider            â”‚
â”‚                                 â”‚
â”‚  3. captureScreen()             â”‚
â”‚     â†’ Buffer                    â”‚
â”‚                                 â”‚
â”‚  4. ocrProvider.analyzeBuffer() â”‚
â”‚     â†’ OCRAnalysis               â”‚
â”‚                                 â”‚
â”‚  5. í…ìŠ¤íŠ¸ ë§¤ì¹­                  â”‚
â”‚     elements.filter(e =>        â”‚
â”‚       e.text.includes('Login')) â”‚
â”‚     â†’ matches[]                 â”‚
â”‚                                 â”‚
â”‚  6. ìµœê³  ì‹ ë¢°ë„ ì„ íƒ             â”‚
â”‚     sort by confidence          â”‚
â”‚     â†’ bestMatch                 â”‚
â”‚                                 â”‚
â”‚  7. Bbox ì¤‘ì‹¬ í´ë¦­               â”‚
â”‚     MouseController.            â”‚
â”‚       clickBBoxCenter(bbox)     â”‚
â”‚                                 â”‚
â”‚  8. ToolResult ë°˜í™˜              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
  â†“
ToolResult
{
  success: true,
  data: JSON.stringify({
    mode: 'ocr',
    text: 'Login',
    foundText: 'Login',
    confidence: 0.95,
    bbox: {x: 100, y: 200, width: 80, height: 30}
  })
}
  â†“
LLMManager.addToolResult('toolu_01A', result.data)
  â†“
History Updated
[
  ...,
  { role: 'tool', tool_call_id: 'toolu_01A', content: '{"mode":"ocr",...}' }
]
```

### Tool ì‹¤í–‰ ì‹œê°„

| Tool | í‰ê·  ì‹œê°„ | ì£¼ìš” ì†Œìš” |
|------|----------|----------|
| EchoTool | < 1ms | ì—†ìŒ |
| ScreenCaptureTool | 100-300ms | robotjs ìº¡ì²˜ |
| OCRTool | 500-1000ms | Vision Framework |
| ClickTool (ì¢Œí‘œ) | 100-200ms | ë§ˆìš°ìŠ¤ ì´ë™ + í´ë¦­ |
| ClickTool (OCR) | 1-2s | í™”ë©´ ìº¡ì²˜ + OCR + í´ë¦­ |
| TypeTool | 50-500ms | í…ìŠ¤íŠ¸ ê¸¸ì´ì— ë”°ë¼ |
| KeyPressTool | 50-100ms | Modifier + Key |
| NavigateToTool | 5-30s | VLM + ì•¡ì…˜ ì‹¤í–‰ |
| SmartScreenReader (quick) | 1-3s | Fast LLM |
| SmartScreenReader (detailed) | 5-10s | Vision LLM + OCR |

---

## Message íë¦„

### Message History êµ¬ì¡°

```typescript
// ì´ˆê¸°
history = []

// User ì…ë ¥
history = [
  { role: 'user', content: 'Navigate to Chrome' }
]

// LLM ì‘ë‹µ (Tool call)
history = [
  { role: 'user', content: 'Navigate to Chrome' },
  {
    role: 'assistant',
    content: [
      { type: 'text', text: "I'll launch Chrome..." },
      {
        type: 'tool_use',
        id: 'toolu_01A',
        name: 'launch_app',
        input: { appName: 'Google Chrome' }
      }
    ]
  }
]

// Tool ê²°ê³¼
history = [
  { role: 'user', content: 'Navigate to Chrome' },
  { role: 'assistant', content: [...] },
  {
    role: 'tool',
    tool_call_id: 'toolu_01A',
    content: '{"appName":"Google Chrome","method":"spotlight",...}'
  }
]

// LLM ìµœì¢… ì‘ë‹µ
history = [
  { role: 'user', content: 'Navigate to Chrome' },
  { role: 'assistant', content: [...] },
  { role: 'tool', tool_call_id: 'toolu_01A', content: '...' },
  {
    role: 'assistant',
    content: [
      { type: 'text', text: "I've successfully launched Google Chrome." }
    ]
  }
]
```

### Message íƒ€ì…ë³„ ë°ì´í„°

#### UserMessage
```typescript
{
  role: 'user',
  content: string | ContentBlock[]
}
```

**ì˜ˆì‹œ**:
```typescript
// Text only
{
  role: 'user',
  content: 'Navigate to Chrome'
}

// MultiModal (Vision)
{
  role: 'user',
  content: [
    { type: 'text', text: 'Analyze this screen' },
    { type: 'image', source: { type: 'base64', data: '...', media_type: 'image/png' } }
  ]
}
```

#### AssistantMessage
```typescript
{
  role: 'assistant',
  content: ContentBlock[]
}
```

**ì˜ˆì‹œ**:
```typescript
{
  role: 'assistant',
  content: [
    { type: 'text', text: "I'll help you..." },
    {
      type: 'tool_use',
      id: 'toolu_01A',
      name: 'launch_app',
      input: { appName: 'Google Chrome' }
    }
  ]
}
```

#### ToolMessage
```typescript
{
  role: 'tool',
  tool_call_id: string,
  content: string
}
```

**ì˜ˆì‹œ**:
```typescript
{
  role: 'tool',
  tool_call_id: 'toolu_01A',
  content: '{"success":true,"appName":"Google Chrome",...}'
}
```

---

## ì „ì²´ ì‹œìŠ¤í…œ ë°ì´í„° íë¦„ ìš”ì•½

```
User Input
    â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Agent (Agentic Loop)                   â”‚
â”‚    â†“                                    â”‚
â”‚  LLMManager (default mode)              â”‚
â”‚    â†“                                    â”‚
â”‚  AnthropicLLM (Stateful)                â”‚
â”‚    â†“                                    â”‚
â”‚  Anthropic API                          â”‚
â”‚    â†“                                    â”‚
â”‚  LLM Response (content + toolCalls)     â”‚
â”‚    â†“                                    â”‚
â”‚  ToolRegistry.execute()                 â”‚
â”‚    â†“                                    â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚  Tool Execution                   â”‚ â”‚
â”‚  â”‚    â†“                              â”‚ â”‚
â”‚  â”‚  NavigateToTool                   â”‚ â”‚
â”‚  â”‚    â†“                              â”‚ â”‚
â”‚  â”‚  NavigationBrain.navigateTo()     â”‚ â”‚
â”‚  â”‚    â†“                              â”‚ â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚ â”‚
â”‚  â”‚  â”‚  identifyCurrentNode()      â”‚ â”‚ â”‚
â”‚  â”‚  â”‚    â†“                        â”‚ â”‚ â”‚
â”‚  â”‚  â”‚  captureScreen              â”‚ â”‚ â”‚
â”‚  â”‚  â”‚    â†“                        â”‚ â”‚ â”‚
â”‚  â”‚  â”‚  OCR (MacOCRProvider)       â”‚ â”‚ â”‚
â”‚  â”‚  â”‚    â†“                        â”‚ â”‚ â”‚
â”‚  â”‚  â”‚  VLM (Vision Mode)          â”‚ â”‚ â”‚
â”‚  â”‚  â”‚    â†“                        â”‚ â”‚ â”‚
â”‚  â”‚  â”‚  StateHasher                â”‚ â”‚ â”‚
â”‚  â”‚  â”‚    â†“                        â”‚ â”‚ â”‚
â”‚  â”‚  â”‚  NodeId                     â”‚ â”‚ â”‚
â”‚  â”‚  â”‚    â†“                        â”‚ â”‚ â”‚
â”‚  â”‚  â”‚  updateShadowDOM()          â”‚ â”‚ â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚ â”‚
â”‚  â”‚    â†“                              â”‚ â”‚
â”‚  â”‚  learnPath() or executePath()     â”‚ â”‚
â”‚  â”‚    â†“                              â”‚ â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚ â”‚
â”‚  â”‚  â”‚  learnPath()                â”‚ â”‚ â”‚
â”‚  â”‚  â”‚    â†“                        â”‚ â”‚ â”‚
â”‚  â”‚  â”‚  VLM (Vision Mode)          â”‚ â”‚ â”‚
â”‚  â”‚  â”‚    â†“                        â”‚ â”‚ â”‚
â”‚  â”‚  â”‚  Action[] ìƒì„±               â”‚ â”‚ â”‚
â”‚  â”‚  â”‚    â†“                        â”‚ â”‚ â”‚
â”‚  â”‚  â”‚  Path ê°ì²´ ìƒì„±              â”‚ â”‚ â”‚
â”‚  â”‚  â”‚    â†“                        â”‚ â”‚ â”‚
â”‚  â”‚  â”‚  JSONStorage.addPath()      â”‚ â”‚ â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚ â”‚
â”‚  â”‚    â†“                              â”‚ â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚ â”‚
â”‚  â”‚  â”‚  executePath()              â”‚ â”‚ â”‚
â”‚  â”‚  â”‚    â†“                        â”‚ â”‚ â”‚
â”‚  â”‚  â”‚  for each action:           â”‚ â”‚ â”‚
â”‚  â”‚  â”‚    â†“                        â”‚ â”‚ â”‚
â”‚  â”‚  â”‚  executeAction()            â”‚ â”‚ â”‚
â”‚  â”‚  â”‚    â”œâ”€ MouseController       â”‚ â”‚ â”‚
â”‚  â”‚  â”‚    â”œâ”€ KeyboardController    â”‚ â”‚ â”‚
â”‚  â”‚  â”‚    â””â”€ delay()               â”‚ â”‚ â”‚
â”‚  â”‚  â”‚    â†“                        â”‚ â”‚ â”‚
â”‚  â”‚  â”‚  updateShadowDOM()          â”‚ â”‚ â”‚
â”‚  â”‚  â”‚    â†“                        â”‚ â”‚ â”‚
â”‚  â”‚  â”‚  verifyActionResult()       â”‚ â”‚ â”‚
â”‚  â”‚  â”‚    â†“                        â”‚ â”‚ â”‚
â”‚  â”‚  â”‚  PathVerification           â”‚ â”‚ â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚ â”‚
â”‚  â”‚    â†“                              â”‚ â”‚
â”‚  â”‚  ToolResult                       â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚    â†“                                    â”‚
â”‚  LLMManager.addToolResult()             â”‚
â”‚    â†“                                    â”‚
â”‚  Loop continues or ends                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
    â†“
AgentResponse
    â†“
Console Output
```

---

## ì •ë¦¬

### í•µì‹¬ ë°ì´í„° íë¦„

1. **User Request â†’ Response**:
   - User Input â†’ Agent â†’ LLM â†’ Tools â†’ LLM â†’ Response
   - Agentic Loop (ìµœëŒ€ 10íšŒ)
   - Message History ëˆ„ì 

2. **NavigateTo**:
   - identifyCurrentNode â†’ learnPath/executePath â†’ verify
   - VLMìœ¼ë¡œ Action ìƒì„±
   - ê° Action ì‹¤í–‰ + ê²€ì¦
   - JSON Storageì— ì €ì¥

3. **ShadowDOM**:
   - í™”ë©´ ìº¡ì²˜ â†’ OCR + VLM â†’ UIElement[]
   - StateHasherë¡œ Hash ìƒì„±
   - ë©”ëª¨ë¦¬ì—ë§Œ ìœ ì§€ (ì €ì¥ ì•ˆ ë¨)

4. **LLM Mode**:
   - Default: Stateful, Tool calling
   - Fast: Stateless, ì €ë ´
   - Vision: Stateless, Image ì§€ì›

5. **Storage**:
   - NavigationGraph â†’ Serialize â†’ JSON íŒŒì¼
   - Node ì¶”ê°€, Path í•™ìŠµ ì‹œ ì €ì¥
   - ì•± ì‹œì‘ ì‹œ ë¡œë“œ

### ë°ì´í„° í¬ê¸° ì¶”ì •

| ë°ì´í„° | í¬ê¸° | ìœ„ì¹˜ |
|--------|------|------|
| Message History | 10-100 KB | ë©”ëª¨ë¦¬ |
| NavigationGraph (12 nodes) | 50-200 KB | ë©”ëª¨ë¦¬ + JSON |
| ShadowDOM (í˜„ì¬) | 2-5 MB | ë©”ëª¨ë¦¬ |
| Screenshot Buffer | 2-5 MB | ì„ì‹œ |
| OCR Result | 10-50 KB | ì„ì‹œ |

**ì´ ë©”ëª¨ë¦¬ ì‚¬ìš©ëŸ‰**: ì•½ 5-15 MB (ì •ìƒ ì‘ë™ ì‹œ)

### ì„±ëŠ¥ ë³‘ëª©

1. **VLM í˜¸ì¶œ**: 3-10ì´ˆ (ê°€ì¥ ëŠë¦¼)
2. **OCR**: 0.5-1ì´ˆ
3. **í™”ë©´ ìº¡ì²˜**: 0.1-0.3ì´ˆ
4. **Tool ì‹¤í–‰**: 0.05-2ì´ˆ
5. **JSON ì €ì¥**: 0.01-0.1ì´ˆ

**ì´ ë„¤ë¹„ê²Œì´ì…˜ ì‹œê°„**: 5-30ì´ˆ (VLM í•™ìŠµ í¬í•¨)
**ì¬ì‚¬ìš© ì‹œ**: 2-5ì´ˆ (ì €ì¥ëœ ê²½ë¡œ ì‹¤í–‰ë§Œ)

### ë¹„ìš© ìµœì í™”

1. **ê²½ë¡œ ì¬ì‚¬ìš©**: VLM í˜¸ì¶œ ìµœì†Œí™” (JSON ìºì‹œ)
2. **Fast Mode**: ê°„ë‹¨í•œ ì‘ì—…ì€ Haiku ì‚¬ìš©
3. **OCR ë¨¼ì €**: VLM ì „ì— OCRë¡œ í…ìŠ¤íŠ¸ ì¶”ì¶œ
4. **Batch Processing**: ì—¬ëŸ¬ ì•¡ì…˜ì„ í•œ ë²ˆì— ì‹¤í–‰

**10ë²ˆ ì „ì²´ ë¬¸ì„œí™” ì™„ë£Œ!** ğŸ‰
